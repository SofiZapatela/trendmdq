<!DOCTYPE html>
<html>
<body>
<h2>Actualizar links de imágenes</h2>
<pre id="log"></pre>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
  import { getFirestore, collection, getDocs, updateDoc, doc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
  import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

  const log = (msg) => document.getElementById("log").textContent += msg + "\n";

  /* --- FIREBASE CONFIG --- */
  const firebaseConfig = {
    apiKey: "AIzaSyAMYXqevFiswKZVICllkDVq2ymj6EgBn6I",
    authDomain: "trendmdq-4e495.firebaseapp.com",
    projectId: "trendmdq-4e495",
    storageBucket: "trendmdq-4e495.firebasestorage.app",
    messagingSenderId: "866820424354",
    appId: "1:866820424354:web:548df9c9c21a881a354dfb"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  /* --- 1) LOGIN ANTES DE EDITAR FIRESTORE --- */
  // ⚠️ ⚠️ CAMBIÁ ESTO POR TU USUARIO ADMIN REAL ⚠️ ⚠️
  await signInWithEmailAndPassword(auth, "sofiazapatela@gmail.com", "Lunitadetucuman98");

  log("Login OK. Empezando actualización...\n");

  /* --- 2) LISTA DE COLECCIONES A ACTUALIZAR --- */
  const colecciones = ["productos", "tejidos"];

  async function updateCollectionImages(col) {
    const snap = await getDocs(collection(db, col));

    for (let d of snap.docs) {
      const data = d.data();

      // si img no existe → lo salteamos
      if (!data.img) continue;

      let nuevasImgs = [];

      // si img NO es array → lo convertimos
      if (typeof data.img === "string") {
        nuevasImgs = [`https://firebasestorage.googleapis.com/v0/b/trendmdq-4e495.firebasestorage.app/o/imagenes%2F${encodeURIComponent(data.img.replace('fotos/', ''))}?alt=media`];
      }

      // si img es array → convertir cada una
      if (Array.isArray(data.img)) {
        nuevasImgs = data.img.map(x =>
          `https://firebasestorage.googleapis.com/v0/b/trendmdq-4e495.firebasestorage.app/o/imagenes%2F${encodeURIComponent(x.replace('fotos/', ''))}?alt=media`
        );
      }

      log(`Actualizando ${col}/${d.id} →`);
      log(nuevasImgs.join("\n") + "\n");

      await updateDoc(doc(db, col, d.id), { img: nuevasImgs });
    }
  }

  /* --- 3) CORRER TODO --- */
  for (let col of colecciones) {
    log("Colección: " + col);
    await updateCollectionImages(col);
  }

  log("TERMINADO ✔");
</script>

</body>
</html>
