<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Trend CMS</title>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>

  <style>
    body { font-family: Arial; max-width: 600px; margin: 20px auto; }
    .hidden { display: none; }
    .producto { border: 1px solid #ddd; padding: 10px; margin: 10px 0; }
    input, textarea, select { width: 100%; padding: 8px; margin: 5px 0; }
    button { padding: 10px; cursor: pointer; }
  </style>
</head>

<body>

  <h1>Trend CMS</h1>

  <!-- LOGIN -->
  <div id="login">
    <h2>Iniciar sesión</h2>
    <input id="email" type="email" placeholder="Email" />
    <input id="password" type="password" placeholder="Contraseña" />
    <button id="btnLogin">Ingresar</button>
    <p id="loginError" style="color:red;"></p>
  </div>

  <!-- PANEL -->
  <div id="panel" class="hidden">
    <h2>Nuevo producto</h2>

    <select id="categoria">
      <option value="productos">Productos</option>
      <option value="tejidos">Tejidos</option>
    </select>

    <input id="nombre" type="text" placeholder="Nombre del producto" />
    <textarea id="descripcion" placeholder="Descripción"></textarea>
    <input id="talle" type="text" placeholder="Talle (ej: S, M, L, XL)" />
    <input id="precio" type="number" placeholder="Precio" />
    <select id="tipo" >
      <option value="vestido">Vestido</option>
      <option value="blusa">Blusa</option>
      <option value="pantalon">Pantalón</option>
      <option value="campera">Campera</option>
      <option value="mono">Mono</option>
      <option value="falda">Falda</option>
      <option value="conjunto">Conjunto</option>
      <option value="chaqueta">Chaqueta</option>
      <option value="zapatos">Zapatos</option>
      <option value="pollera">Pollera</option>
    </select>
    <input type="file" id="imagen" multiple />



    <button id="btnGuardar">Guardar producto</button>

    <h2>Productos cargados</h2>
    <div id="lista"></div>
  </div>

<script>
  /* --- 1) CONFIG FIREBASE --- */
  const firebaseConfig = {
    apiKey: "AIzaSyAMYXqevFiswKZVICllkDVq2ymj6EgBn6I",
    authDomain: "trendmdq-4e495.firebaseapp.com",
    projectId: "trendmdq-4e495",
    storageBucket: "trendmdq-4e495.firebasestorage.app",
    messagingSenderId: "866820424354",
    appId: "1:866820424354:web:548df9c9c21a881a354dfb"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();
  const storage = firebase.storage();

  /* --- 2) LOGIN --- */
  btnLogin.onclick = () => {
    const emailVal = document.getElementById("email").value;
    const passVal = document.getElementById("password").value;

    auth.signInWithEmailAndPassword(emailVal, passVal)
      .then(() => {
        login.classList.add("hidden");
        panel.classList.remove("hidden");
        cargarProductos();
      })
      .catch(() => loginError.textContent = "Email o contraseña incorrectos");
  };

  /* --- 3) SUBIR IMAGEN --- */
  async function subirImagen(file) {
    const ref = storage.ref("productos/" + Date.now() + "-" + file.name);
    await ref.put(file);
    return await ref.getDownloadURL();
  }

  /* --- 4) GUARDAR PRODUCTO --- */
 btnGuardar.onclick = async () => {
  const nombreP = nombre.value.trim();
  const descripcionP = descripcion.value.trim();
  const precioP = Number(precio.value);
  const categoriaP = categoria.value;
  const tallesArr = talle.value.trim().split(",").map(t => t.trim()).filter(t => t);

  const files = imagen.files; // <--- ahora tomamos los archivos

  if (!nombreP || !descripcionP || !precioP || files.length === 0) {
    return alert("Faltan datos o no subiste imágenes");
  }

  // Subimos todas las imágenes y guardamos las URLs en un array
  let imagenesUrls = [];
  for (let file of files) {
    const url = await subirImagen(file);
    imagenesUrls.push(url);
  }

  // Crear slug automático
  const slug = nombreP
    .toLowerCase()
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "")
    .replace(/[^a-z0-9]+/g, "-")
    .replace(/^-+|-+$/g, "");

  // Guardar en Firestore
  await db.collection(categoriaP).doc(slug).set({
    titulo: nombreP,
    desc: descripcionP,
    precio: precioP,
    img: imagenesUrls,         // <-- ahora es array real de URLs subidas
    href: `producto.html?slug=${slug}`,
    slug: slug,
    tipo: categoriaP,
    talle: tallesArr,
    creado: Date.now()
    
  });
  alert("Producto cargado!")

  // Limpiar campos
  nombre.value = "";
  descripcion.value = "";
  precio.value = "";
  categoria.value = "productos";
  imagen.value = "";
  talle.value = "";

  cargarProductos();
};



  /* --- 5) LISTAR PRODUCTOS --- */
async function cargarProductos() {
  lista.innerHTML = "";

  const categorias = ["productos", "tejidos"];

  for (let cat of categorias) {
    const snap = await db.collection(cat).get();

    snap.forEach(doc => {
      const p = doc.data();

      // Usar la URL directa que viene de Firebase
      let urlCompleta = "";
      if (Array.isArray(p.img) && p.img.length > 0) {
        urlCompleta = p.img[0];
      }
      if (typeof p.img === "string") {
        urlCompleta = p.img;
      }

      const div = document.createElement("div");
      div.className = "producto";

      div.innerHTML = `
        <strong>${cat.toUpperCase()}</strong>
        <h3>${p.nombre || p.titulo || ""}</h3>
        <img src="${urlCompleta}" width="150" />
        <p>${p.descripcion || p.desc || ""}</p>
        <p><strong>$${p.precio || ""}</strong></p>
        <p><strong>Talles: </strong>${Array.isArray(p.talle) ? p.talle.join(", ") : ""}</p>
        <button onclick="borrar('${cat}', '${doc.id}')">Borrar</button>
      `;

      lista.appendChild(div);
    });
  }
}




/* --- 6) BORRAR PRODUCTO --- */
window.borrar = async (cat, id) => {
  const seguro = confirm("¿Estás segura/o que querés borrar este producto? Esta acción no se puede deshacer.");

  if (!seguro) return; // Si aprieta "Cancelar", NO borra nada.

  await db.collection(cat).doc(id).delete();

  alert("Producto eliminado exitosamente");
  cargarProductos();
};

</script>

</body>
</html>
