<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Trend CMS</title>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>

  <style>
    body { font-family: Arial; max-width: 600px; margin: 20px auto; }
    .hidden { display: none; }
    .producto { border: 1px solid #ddd; padding: 10px; margin: 10px 0; }
    input, textarea, select { width: 100%; padding: 8px; margin: 5px 0; }
    button { padding: 10px; cursor: pointer; }
  </style>
</head>

<body>

  <h1>Trend CMS</h1>

  <!-- LOGIN -->
  <div id="login">
    <h2>Iniciar sesi√≥n</h2>
    <input id="email" type="email" placeholder="Email" />
    <input id="password" type="password" placeholder="Contrase√±a" />
    <button id="btnLogin">Ingresar</button>
    <p id="loginError" style="color:red;"></p>
  </div>

  <!-- PANEL -->
  <div id="panel" class="hidden">
    <h2>Nuevo producto</h2>

    <select id="categoria">
      <option value="productos">Productos</option>
      <option value="tejidos">Tejidos</option>
    </select>

    <input id="nombre" type="text" placeholder="Nombre del producto" />
    <textarea id="descripcion" placeholder="Descripci√≥n"></textarea>
    <input id="talle" type="text" placeholder="Talle (ej: S, M, L, XL)" />
    <input id="precio" type="number" placeholder="Precio" />
    <select id="tipo" >
      <option value="vestido">Vestido</option>
      <option value="blusa">Blusa</option>
      <option value="pantalon">Pantal√≥n</option>
      <option value="campera">Campera</option>
      <option value="mono">Mono</option>
      <option value="falda">Falda</option>
      <option value="conjunto">Conjunto</option>
      <option value="chaqueta">Chaqueta</option>
      <option value="zapatos">Zapatos</option>
      <option value="accesorios">Accesorios</option>
    </select>
    <input type="file" id="imagen" multiple />



    <button id="btnGuardar">Guardar producto</button>

    <h2>Productos cargados</h2>
    <div id="lista"></div>
  </div>

<script>
  /* --- 1) CONFIG FIREBASE --- */
  const firebaseConfig = {
    apiKey: "AIzaSyAMYXqevFiswKZVICllkDVq2ymj6EgBn6I",
    authDomain: "trendmdq-4e495.firebaseapp.com",
    projectId: "trendmdq-4e495",
    storageBucket: "trendmdq-4e495.firebasestorage.app",
    messagingSenderId: "866820424354",
    appId: "1:866820424354:web:548df9c9c21a881a354dfb"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();
  const storage = firebase.storage();

  // GLOBAL: estado de edici√≥n
  let editando = null;


  /* --- 2) LOGIN --- */
  btnLogin.onclick = () => {
    const emailVal = document.getElementById("email").value;
    const passVal = document.getElementById("password").value;

    auth.signInWithEmailAndPassword(emailVal, passVal)
      .then(() => {
        login.classList.add("hidden");
        panel.classList.remove("hidden");
        cargarProductos();
      })
      .catch(() => loginError.textContent = "Email o contrase√±a incorrectos");
  };

  /* --- 3) SUBIR IMAGEN --- */
    async function procesarImagen(file, maxSize = 900) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.readAsDataURL(file);

      reader.onload = (e) => {
        const img = new Image();
        img.src = e.target.result;

        img.onload = () => {
          const canvas = document.createElement("canvas");
          let width = img.width;
          let height = img.height;

          // Ajustar proporciones
          if (width > height) {
            if (width > maxSize) {
              height *= maxSize / width;
              width = maxSize;
            }
          } else {
            if (height > maxSize) {
              width *= maxSize / height;
              height = maxSize;
            }
          }

          canvas.width = width;
          canvas.height = height;

          const ctx = canvas.getContext("2d");
          ctx.drawImage(img, 0, 0, width, height);

          // Convertir a WebP
          canvas.toBlob(
            (blob) => {
              if (!blob) return reject("Error al convertir a WebP");
              resolve(blob);
            },
            "image/webp",
            0.8 // calidad
          );
        };
      };
    });
  }

  async function subirImagen(file) {
    try {
      console.log("Procesando archivo:", file.name);
      // procesa a webp y 900px (tu procesarImagen ya lo hace)
      const webpBlob = await procesarImagen(file);

      const newName = Date.now() + "-" + file.name.replace(/\.[^.]+$/, "") + ".webp";
      const ref = storage.ref("productos/" + newName);

      const uploadTask = await ref.put(webpBlob, { contentType: "image/webp" });
      console.log("Upload completo:", uploadTask.metadata.fullPath);

      const url = await ref.getDownloadURL();
      console.log("URL obtenida:", url);
      return url;
    } catch (err) {
      console.error("Error en subirImagen:", err);
      throw err; // que lo maneje el caller
    }
  }



  /* --- 4) GUARDAR PRODUCTO --- */
 btnGuardar.onclick = async () => {
  try {
    const files = imagen.files;
    console.log("btnGuardar click ‚Äî editando?", editando, "files:", files.length);

    if (editando) {
      const { categoria: catOld, id: idOld, imagenesActuales } = editando;

      let imagenesUrls = imagenesActuales || [];

      if (files.length > 0) {
        imagenesUrls = [];
        for (let file of files) {
          const url = await subirImagen(file);
          imagenesUrls.push(url);
        }
      } // else mantiene imagenesActuales

      console.log("Actualizando documento", catOld, idOld, "con imgs:", imagenesUrls);
      await db.collection(catOld).doc(idOld).update({
        titulo: nombre.value.trim(),
        desc: descripcion.value.trim(),
        precio: Number(precio.value),
        img: imagenesUrls,
        tipo: tipo.value,
        talle: talle.value.trim().split(",").map(t=>t.trim()).filter(t=>t)
      });
      console.log("Firestore update OK");
      alert("Producto actualizado!");

          // Limpiar formulario
      nombre.value = "";
      descripcion.value = "";
      precio.value = "";
      imagen.value = "";
      categoria.value = "productos";
      talle.value = "";
      
      editando = null;
      btnGuardar.textContent = "Guardar producto";
      cargarProductos();
      return;
    } else {
  // üü£ SI ES UN PRODUCTO NUEVO
  if (files.length === 0) return alert("Sub√≠ al menos una imagen.");

  let imagenesUrls = [];

  for (let file of files) {
    const url = await subirImagen(file);
    imagenesUrls.push(url);
  }

  const nombreP = nombre.value.trim();
  const descripcionP = descripcion.value.trim();
  const precioP = Number(precio.value);
  const categoriaP = categoria.value;
  const tipoP = tipo.value;

  const tallesArr = talle.value
    .trim()
    .split(",")
    .map(t => t.trim())
    .filter(t => t);

  const slug = nombreP
    .toLowerCase()
    .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
    .replace(/[^a-z0-9]+/g, "-")
    .replace(/^-+|-+$/g, "");

  await db.collection(categoriaP).doc(slug).set({
    titulo: nombreP,
    desc: descripcionP,
    precio: precioP,
    img: imagenesUrls,
    href: `producto.html?slug=${slug}`,
    slug: slug,
    tipo: tipoP,
    talle: tallesArr,
    creado: Date.now()
  });

  alert("Producto cargado!");
}

  // Limpiar formulario
  nombre.value = "";
  descripcion.value = "";
  precio.value = "";
  imagen.value = "";
  categoria.value = "productos";
  talle.value = "";

  cargarProductos();
} catch (err) {
    console.error("Error en guardar producto:", err);
    alert("Ocurri√≥ un error. Mir√° la consola para detalles.");
  }
};




  /* --- 5) LISTAR PRODUCTOS --- */
async function cargarProductos() {
  lista.innerHTML = "";

  const categorias = ["productos", "tejidos"];

  for (let cat of categorias) {
    const snap = await db.collection(cat).get();

    snap.forEach(doc => {
      const p = doc.data();

      // Usar la URL directa que viene de Firebase
      let urlCompleta = "";
      if (Array.isArray(p.img) && p.img.length > 0) {
        urlCompleta = p.img[0];
      }
      if (typeof p.img === "string") {
        urlCompleta = p.img;
      }

      const div = document.createElement("div");
      div.className = "producto";

      div.innerHTML = `
        <strong>${cat.toUpperCase()}</strong>
        <h3>${p.nombre || p.titulo || ""}</h3>
        <img src="${urlCompleta}" width="150" />
        <p>${p.descripcion || p.desc || ""}</p>
        <p><strong>$${p.precio || ""}</strong></p>
        <p><strong>Talles: </strong>${Array.isArray(p.talle) ? p.talle.join(", ") : ""}</p>
        <button onclick="borrar('${cat}', '${doc.id}')">Borrar</button>
        <button onclick="editar('${cat}', '${doc.id}')">Editar</button>
      `;

      lista.appendChild(div);
    });
  }
}




/* --- 6) BORRAR PRODUCTO --- */
window.borrar = async (cat, id) => {
  const seguro = confirm("¬øEst√°s segura/o que quer√©s borrar este producto? Esta acci√≥n no se puede deshacer.");

  if (!seguro) return; // Si aprieta "Cancelar", NO borra nada.

  await db.collection(cat).doc(id).delete();

  alert("Producto eliminado exitosamente");
  cargarProductos();
};

window.editar = async (cat, id) => {
  const docRef = await db.collection(cat).doc(id).get();
  const p = docRef.data();

  // Guardamos estado
  editando = {
    categoria: cat,
    id: id,
    imagenesActuales: p.img
  };

  // Cargar datos en el formulario
  categoria.value = cat;
  nombre.value = p.titulo || p.nombre || "";
  descripcion.value = p.desc || p.descripcion || "";
  precio.value = p.precio || "";
  tipo.value = p.tipo || "vestido";
  talle.value = Array.isArray(p.talle) ? p.talle.join(", ") : "";

  btnGuardar.textContent = "Guardar cambios";

  window.scrollTo({ top: 0, behavior: "smooth" });
};


</script>

</body>
</html>
